import os

import numpy as np
import pandas as pd
import matplotlib

matplotlib.rcParams['pdf.fonttype'] = 42
matplotlib.rcParams['ps.fonttype'] = 42

import matplotlib.pyplot as plt
import seaborn as sns
from ark.utils.plot_utils import cohort_cluster_plot
import ark.settings as settings


base_dir = '/Volumes/Shared/Noah Greenwald/TONIC_Cohort'
metadata_dir = os.path.join(base_dir, 'intermediate_files/metadata')
image_dir = os.path.join(base_dir, 'image_data/samples/')
seg_dir = os.path.join(base_dir, 'segmentation_data/deepcell_output')
plot_dir = os.path.join(base_dir, 'figures')

harmonized_metadata = pd.read_csv(os.path.join(metadata_dir, 'harmonized_metadata.csv'))
study_fovs = harmonized_metadata.loc[harmonized_metadata.Timepoint.isin(['primary_untreated', 'baseline', 'post_induction', 'on_nivo']), 'fov'].values


# tumor compartment overlays
annotations_by_mask = pd.read_csv(os.path.join(base_dir, 'intermediate_files/mask_dir', 'cell_annotation_mask.csv'))

compartment_colormap = pd.DataFrame({'mask_name': ['cancer_core', 'cancer_border', 'stroma_border', 'stroma_core'],
                         'color': ['blue', 'deepskyblue', 'lightcoral', 'firebrick']})

compartment_plot_dir = os.path.join(plot_dir, 'Figure2a_compartment_overlays')
if not os.path.exists(compartment_plot_dir):
    os.mkdir(compartment_plot_dir)

# generate sampling of overlays across range of compartment frequencies to pick images
# # set thresholds
# fov_features = pd.read_csv(os.path.join(base_dir, 'analysis_files/fov_features_filtered.csv'))
# fov_features = fov_features.loc[fov_features.fov.isin(study_fovs), :]
# compartment_features = fov_features.loc[(fov_features.feature_name == 'cancer_core__proportion'), :]
#
# sns.histplot(data=compartment_features, x='raw_value',  bins=20, multiple='stack')
#
# # set thresholds for each group
# thresholds = {'low': [0.01, 0.1], 'mid': [0.3, .5], 'high': [0.6, 1]}
#
#
# # generate overlays

#
# for group in thresholds.keys():
#     group_dir = os.path.join(compartment_plot_dir, group)
#     if not os.path.exists(group_dir):
#         os.mkdir(group_dir)
#
#     min_val, max_val = thresholds[group]
#
#     # get fovs
#     fovs = compartment_features.loc[(compartment_features.raw_value > min_val) &
#                                         (compartment_features.raw_value < max_val), 'fov'].values
#
#     fovs = fovs[:10]
#     # generate overlays
#     cell_table_subset = annotations_by_mask.loc[(annotations_by_mask.fov.isin(fovs)), :]
#
#     cohort_cluster_plot(
#         fovs=fovs,
#         seg_dir=seg_dir,
#         save_dir=group_dir,
#         cell_data=annotations_by_mask,
#         erode=True,
#         fov_col=settings.FOV_ID,
#         label_col=settings.CELL_LABEL,
#         cluster_col='mask_name',
#         seg_suffix="_whole_cell.tiff",
#         cmap=compartment_colormap,
#         display_fig=False,
#     )

# generate only selected overlays for figure
selected_compartment_fovs = ['TONIC_TMA3_R11C6', 'TONIC_TMA2_R7C3']
cell_table_subset = annotations_by_mask.loc[(annotations_by_mask.fov.isin(selected_compartment_fovs)), :]

cohort_cluster_plot(
    fovs=selected_compartment_fovs,
    seg_dir=seg_dir,
    save_dir=compartment_plot_dir,
    cell_data=cell_table_subset,
    erode=True,
    fov_col=settings.FOV_ID,
    label_col=settings.CELL_LABEL,
    cluster_col='mask_name',
    seg_suffix="_whole_cell.tiff",
    cmap=compartment_colormap,
    display_fig=False,
)

# cell proliferation
cell_table_func = pd.read_csv(os.path.join(base_dir, 'analysis_files/cell_table_func_single_positive.csv'))

cell_table_subset = cell_table_func.loc[(cell_table_func.fov.isin(study_fovs)), :]

ki67_colormap = pd.DataFrame({'proliferating': ['True', 'False'],
                            'color': ['red', 'dimgrey']})

cell_table_subset['proliferating'] = cell_table_subset.Ki67.astype(str)

ki67_plot_dir = os.path.join(plot_dir, 'Figure2a_ki67_overlays')
if not os.path.exists(ki67_plot_dir):
    os.mkdir(ki67_plot_dir)

# generate sampling of Ki67 proliferation levels to pick images

# # proliferating tumor cells
# ki67_features = fov_features.loc[(fov_features.feature_name == 'Ki67+__all') & (fov_features.compartment == 'all'), :]
#
# sns.histplot(data=ki67_features, x='raw_value',  bins=20, multiple='stack')
#
# # set thresholds for each group
# thresholds = {'low': [0.01, 0.2], 'mid': [0.2, .4], 'high': [0.5, 1]}

# for group in thresholds.keys():
#     group_dir = os.path.join(ki67_plot_dir, group)
#     if not os.path.exists(group_dir):
#         os.mkdir(group_dir)
#
#     min_val, max_val = thresholds[group]
#
#     # get fovs
#     fovs = ki67_features.loc[(ki67_features.raw_value > min_val) &
#                                         (ki67_features.raw_value < max_val), 'fov'].values
#
#     fovs = fovs[:10]
#
#     # generate overlays
#     cohort_cluster_plot(
#         fovs=fovs,
#         seg_dir=seg_dir,
#         save_dir=group_dir,
#         cell_data=cell_table_subset,
#         erode=True,
#         fov_col=settings.FOV_ID,
#         label_col=settings.CELL_LABEL,
#         cluster_col='proliferating',
#         seg_suffix="_whole_cell.tiff",
#         cmap=ki67_colormap,
#         display_fig=False,
#     )

# generate only selected overlays for figure
selected_ki67_fovs = ['TONIC_TMA14_R10C1', 'TONIC_TMA10_R1C5']
cohort_cluster_plot(
    fovs=selected_ki67_fovs,
    seg_dir=seg_dir,
    save_dir=ki67_plot_dir,
    cell_data=cell_table_subset,
    erode=True,
    fov_col=settings.FOV_ID,
    label_col=settings.CELL_LABEL,
    cluster_col='proliferating',
    seg_suffix="_whole_cell.tiff",
    cmap=ki67_colormap,
    display_fig=False,
)

# CD8T density
cell_table_clusters = pd.read_csv(os.path.join(base_dir, 'analysis_files/cell_table_clusters.csv'))
cell_table_clusters['CD8T_plot'] = cell_table_clusters.cell_cluster
cell_table_clusters.loc[cell_table_clusters.cell_cluster != 'CD8T', 'CD8T_plot'] = 'Other'

# set up plotting
CD8_colormap = pd.DataFrame({'CD8T_plot': ['CD8T', 'Other'],
                            'color': ['navajowhite', 'dimgrey']})

CD8_plot_dir = os.path.join(plot_dir, 'Figure2a_CD8_overlays')
if not os.path.exists(CD8_plot_dir):
    os.mkdir(CD8_plot_dir)

# generate sampling of CD8T levels to pick images
# CD8T_features = fov_features.loc[(fov_features.feature_name == 'CD8T__cluster_density') & (fov_features.compartment == 'all'), :]
#
# sns.histplot(data=CD8T_features, x='raw_value',  bins=20, multiple='stack')
#
#
# # set thresholds for each group
# thresholds = {'low': [0.001, 0.05], 'mid': [0.1, 0.2], 'high': [0.3, 0.6]}
#
# for group in thresholds.keys():
#     group_dir = os.path.join(CD8_plot_dir, group)
#     if not os.path.exists(group_dir):
#         os.mkdir(group_dir)
#
#     min_val, max_val = thresholds[group]
#
#     # get fovs
#     fovs = CD8T_features.loc[(CD8T_features.raw_value > min_val) &
#                              (CD8T_features.raw_value < max_val), 'fov'].values
#
#     fovs = fovs[:10]
#     # generate overlays
#     cell_table_subset = cell_table_clusters.loc[(cell_table_clusters.fov.isin(fovs)), :]
#
#     cohort_cluster_plot(
#         fovs=fovs,
#         seg_dir=seg_dir,
#         #save_dir=group_dir,
#         save_dir=CD8_plot_dir,
#         cell_data=cell_table_subset,
#         erode=True,
#         fov_col=settings.FOV_ID,
#         label_col=settings.CELL_LABEL,
#         cluster_col='CD8T_plot',
#         seg_suffix="_whole_cell.tiff",
#         cmap=CD8_colormap,
#         display_fig=False,
#     )

# generate only selected overlays for figure
selected_cd8_fovs = ['TONIC_TMA18_R4C6', 'TONIC_TMA10_R5C2']
cell_table_subset = cell_table_clusters.loc[(cell_table_clusters.fov.isin(selected_cd8_fovs)), :]

cohort_cluster_plot(
    fovs=selected_cd8_fovs,
    seg_dir=seg_dir,
    save_dir=CD8_plot_dir,
    cell_data=cell_table_subset,
    erode=True,
    fov_col=settings.FOV_ID,
    label_col=settings.CELL_LABEL,
    cluster_col='CD8T_plot',
    seg_suffix="_whole_cell.tiff",
    cmap=CD8_colormap,
    display_fig=False,
)

# Image diversity
diversity_plot_dir = os.path.join(plot_dir, 'Figure2a_diversity_overlays')
if not os.path.exists(diversity_plot_dir):
    os.mkdir(diversity_plot_dir)

diversity_colormap = pd.DataFrame({'cell_cluster_broad': ['Cancer', 'Structural', 'Mono_Mac', 'T',
                                                          'Other', 'Granulocyte', 'NK', 'B'],
                                   'color': ['dimgrey', 'darksalmon', 'red', 'navajowhite',
                                             'yellowgreen',
                                             'aqua', 'dodgerblue', 'darkviolet']})

# generate sampling of diversity levels to pick images
# diversity_features = fov_features.loc[(fov_features.feature_name == 'cluster_broad_diversity') &
#                                       (fov_features.compartment == 'all'), :]
#
# sns.histplot(data=diversity_features, x='raw_value',  bins=20, multiple='stack')
#
# # set thresholds for each group
# thresholds = {'low': [0.1, 0.5], 'mid': [1, 1.5], 'high': [2, 3]}
#
# for group in thresholds.keys():
#     group_dir = os.path.join(diversity_plot_dir, group)
#     if not os.path.exists(group_dir):
#         os.mkdir(group_dir)
#
#     min_val, max_val = thresholds[group]
#
#     # get fovs
#     fovs = diversity_features.loc[(diversity_features.raw_value > min_val) &
#                                         (diversity_features.raw_value < max_val), 'fov'].values
#
#     fovs = fovs[:10]
#     # generate overlays
#     cell_table_subset = cell_table_clusters.loc[(cell_table_clusters.fov.isin(fovs)), :]
#
#     cohort_cluster_plot(
#         fovs=fovs,
#         seg_dir=seg_dir,
#         save_dir=group_dir,
#         cell_data=cell_table_subset,
#         erode=True,
#         fov_col=settings.FOV_ID,
#         label_col=settings.CELL_LABEL,
#         cluster_col='cell_cluster_broad',
#         seg_suffix="_whole_cell.tiff",
#         cmap=diversity_colormap,
#         display_fig=False,
#     )

# generate only selected overlays for figure
selected_diversity_fovs = ['TONIC_TMA10_R5C6', 'TONIC_TMA15_R8C2']
cell_table_subset = cell_table_clusters.loc[(cell_table_clusters.fov.isin(selected_diversity_fovs)), :]

cohort_cluster_plot(
    fovs=selected_diversity_fovs,
    seg_dir=seg_dir,
    save_dir=diversity_plot_dir,
    cell_data=cell_table_subset,
    erode=True,
    fov_col=settings.FOV_ID,
    label_col=settings.CELL_LABEL,
    cluster_col='cell_cluster_broad',
    seg_suffix="_whole_cell.tiff",
    cmap=diversity_colormap,
    display_fig=False,
)

# summary plots for features
feature_metadata = pd.read_csv(os.path.join(base_dir, 'analysis_files/feature_metadata.csv'))
feature_classes = {'cell_abundance': ['density', 'density_ratio', 'density_proportion'],
                     'diversity': ['cell_diversity', 'region_diversity'],
                     'cell_phenotype': ['functional_marker', 'morphology', ],
                     'cell_interactions': ['mixing_score', 'linear_distance'],
                   'structure': ['compartment_area_ratio', 'compartment_area', 'ecm_cluster', 'ecm_fraction', 'pixie_ecm', 'fiber']}

for feature_class in feature_classes.keys():
    feature_metadata.loc[feature_metadata.feature_type.isin(feature_classes[feature_class]), 'feature_class'] = feature_class

sns.countplot(data=feature_metadata, x='feature_class', order=['cell_phenotype', 'cell_abundance', 'diversity', 'structure', 'cell_interactions'],
              color='grey')
sns.despine()
plt.tight_layout()
plt.savefig(os.path.join(plot_dir, 'Figure3_feature_class_counts.pdf'))
plt.close()

# stacked bar version
feature_metadata_stacked = feature_metadata.copy()
feature_metadata_stacked['count'] = 1
feature_metadata_stacked = feature_metadata_stacked[['feature_class', 'count']].groupby(['feature_class']).sum().reset_index()
feature_metadata_stacked['feature'] = 'feature1'
feature_metadata_stacked['feature2'] = 'feature2'

feature_metadata_wide = pd.pivot(feature_metadata_stacked, index='feature', columns='feature_class', values='count')
feature_metadata_wide = feature_metadata_wide[['cell_phenotype', 'cell_abundance', 'diversity', 'structure', 'cell_interactions']]
feature_metadata_wide.plot.bar(stacked=True)
sns.despine()
plt.ylim(0, 1000)
plt.yticks(np.arange(0, 1001, 200))
plt.savefig(os.path.join(plot_dir, 'Figure3_feature_class_counts_stacked.pdf'))
plt.close()

cell_classes = {'Immune': ['Immune', 'Mono_Mac', 'T', 'Granulocyte'], 'Cancer': ['Cancer'],
                'Stroma': ['Stroma'], 'Structural': ['ecm'], 'Multiple': ['multiple', 'all']}

for cell_class in cell_classes.keys():
    feature_metadata.loc[feature_metadata.cell_pop.isin(cell_classes[cell_class]), 'cell_class'] = cell_class


sns.countplot(data=feature_metadata, x='cell_class', order=['Immune', 'Multiple', 'Cancer', 'Stroma', 'Structural'],
                color='grey')

sns.despine()
plt.tight_layout()
plt.savefig(os.path.join(plot_dir, 'Figure3_cell_class_counts.pdf'))
plt.close()


# stacked bar version
feature_metadata_stacked = feature_metadata.copy()
feature_metadata_stacked['count'] = 1
feature_metadata_stacked = feature_metadata_stacked[['cell_class', 'count']].groupby(['cell_class']).sum().reset_index()
feature_metadata_stacked['feature'] = 'feature1'
feature_metadata_stacked['feature2'] = 'feature2'

feature_metadata_wide = pd.pivot(feature_metadata_stacked, index='feature', columns='cell_class', values='count')

# set order for stacked bar
feature_metadata_wide = feature_metadata_wide[['Immune', 'Multiple', 'Cancer', 'Stroma', 'Structural']]
feature_metadata_wide.plot.bar(stacked=True)
sns.despine()
plt.ylim(0, 1000)
plt.yticks(np.arange(0, 1001, 200))

plt.savefig(os.path.join(plot_dir, 'Figure3_cell_class_counts_stacked.pdf'))
plt.close()



# cluster features together to identify modules
fov_data_df = pd.read_csv(os.path.join(base_dir, 'analysis_files/fov_features_filtered.csv'))
fov_data_df = fov_data_df.loc[fov_data_df.fov.isin(study_fovs), :]

# create wide df
fov_data_wide = fov_data_df.pivot(index='fov', columns='feature_name_unique', values='normalized_value')
corr_df = fov_data_wide.corr(method='spearman')
corr_df = corr_df.fillna(0)


clustergrid = sns.clustermap(corr_df, cmap='vlag', vmin=-1, vmax=1, figsize=(20, 20))
clustergrid.savefig(os.path.join(plot_dir, 'Figure3_feature_clustermap_filtered.pdf'), dpi=300)
plt.close()

# get names of features from clustergrid
feature_names = clustergrid.data2d.columns

start_idx = 710
end_idx = 750
clustergrid_small = sns.clustermap(corr_df.loc[feature_names[start_idx:end_idx], feature_names[start_idx:end_idx]], cmap='vlag', vmin=-1, vmax=1, figsize=(20, 20),
                                   col_cluster=False, row_cluster=False)
clustergrid_small.savefig(os.path.join(plot_dir, 'spearman_correlation_dp_functional_markers_clustermap_small_3.png'), dpi=300)
plt.close()